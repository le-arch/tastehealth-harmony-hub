import{s as a}from"./SupabaseClient-C5AFRzKB.js";const _=[{level:1,min_points:0,max_points:99,title:"Nutrition Novice"},{level:2,min_points:100,max_points:249,title:"Health Explorer"},{level:3,min_points:250,max_points:499,title:"Wellness Seeker"},{level:4,min_points:500,max_points:999,title:"Nutrition Enthusiast"},{level:5,min_points:1e3,max_points:1999,title:"Health Advocate"},{level:6,min_points:2e3,max_points:3499,title:"Wellness Warrior"},{level:7,min_points:3500,max_points:5999,title:"Nutrition Master"},{level:8,min_points:6e3,max_points:9999,title:"Health Champion"},{level:9,min_points:1e4,max_points:14999,title:"Wellness Guru"},{level:10,min_points:15e3,max_points:Number.POSITIVE_INFINITY,title:"Nutrition Legend"}],f={async getChallenges(){const{data:e,error:t}=await a.from("nutrition_challenges").select("*").eq("active",!0);if(t)throw t;return e||[]},async getUserChallenges(e){const{data:t,error:r}=await a.from("user_challenges").select("*, challenge:challenge_id(*)").eq("user_id",e);if(r)throw r;return t||[]},async acceptChallenge(e,t){const{data:r,error:i}=await a.from("user_challenges").insert({user_id:e,challenge_id:t,status:"in_progress",progress:{}}).select().single();if(i)throw i;return r},async updateChallengeProgress(e,t){const{data:r,error:i}=await a.from("user_challenges").update({progress:t}).eq("id",e).select().single();if(i)throw i;return r},async completeChallenge(e){const{data:t,error:r}=await a.from("user_challenges").update({status:"completed",completed_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;const i=await this.getChallengeById(t.challenge_id);return i&&await this.awardPoints(t.user_id,i.points,"challenge_completed",t.challenge_id,"challenge"),t},async getChallengeById(e){const{data:t,error:r}=await a.from("nutrition_challenges").select("*").eq("id",e).single();return r?null:t},async getAchievements(){const{data:e,error:t}=await a.from("achievements").select("*");if(t)throw t;return e||[]},async getUserAchievements(e){const{data:t,error:r}=await a.from("user_achievements").select("*, achievement:achievement_id(*)").eq("user_id",e);if(r)throw r;return t||[]},async awardAchievement(e,t){const{data:r}=await a.from("user_achievements").select("*").eq("user_id",e).eq("achievement_id",t).maybeSingle();if(r)return r;const{data:i,error:o}=await a.from("user_achievements").insert({user_id:e,achievement_id:t}).select().single();if(o)throw o;const s=await this.getAchievementById(t);return s&&await this.awardPoints(e,s.points,"achievement_earned",t,"achievement"),i},async getAchievementById(e){const{data:t,error:r}=await a.from("achievements").select("*").eq("id",e).single();return r?null:t},async getBadges(){const{data:e,error:t}=await a.from("badges").select("*");if(t)throw t;return e||[]},async getUserBadges(e){const{data:t,error:r}=await a.from("user_badges").select("*, badge:badge_id(*)").eq("user_id",e);if(r)throw r;return t||[]},async awardBadge(e,t){const{data:r}=await a.from("user_badges").select("*").eq("user_id",e).eq("badge_id",t).maybeSingle();if(r)return r;const{data:i,error:o}=await a.from("user_badges").insert({user_id:e,badge_id:t}).select().single();if(o)throw o;return i},async equipBadge(e,t){const{data:r,error:i}=await a.from("user_badges").update({is_equipped:t}).eq("id",e).select().single();if(i)throw i;return r},async getUserPoints(e){if(!e)return null;const{data:t,error:r}=await a.from("user_points").select("*").eq("user_id",e).single();return r?r.code==="PGRST116"?this.initializeUserPoints(e):(console.error("Error fetching user points:",r),null):t},async initializeUserPoints(e){const t={user_id:e,total_points:0,current_level:1,points_to_next_level:100},{data:r,error:i}=await a.from("user_points").insert(t).select().single();return i?(console.error("Error initializing user points:",i),null):r},calculateLevel(e){for(const t of _)if(e>=t.min_points&&e<=t.max_points)return t.level;return _[_.length-1].level},getLevelInfo(e){return _.find(t=>t.level===e)||_[0]},getPointsForNextLevel(e){const t=this.calculateLevel(e),r=_.find(i=>i.level===t+1);return r?r.min_points-e:0},async getLevelBenefits(e,t){const{data:r,error:i}=await a.from("level_benefits").select("*").eq("active",!0).order("level_required",{ascending:!0});if(i)throw i;return r||[]},async getUserLevelBenefits(e){const{data:t,error:r}=await a.from("user_level_benefits").select("*, level_benefit:level_benefit_id(*)").eq("user_id",e);if(r)throw r;return t||[]},async unlockLevelBenefit(e,t){const{data:r}=await a.from("user_level_benefits").select("*").eq("user_id",e).eq("level_benefit_id",t).maybeSingle();if(r)return r;const{data:i,error:o}=await a.from("level_benefits").select("*").eq("id",t).single();if(o)throw o;const s=await this.getUserPoints(e);if(s.level<i.level_required)throw new Error(`User level ${s.level} is below required level ${i.level_required}`);const{data:n,error:u}=await a.from("user_level_benefits").insert({user_id:e,level_benefit_id:t,status:"unlocked"}).select().single();if(u)throw u;return n},async useLevel(e,t,r){var u,l;const{data:i,error:o}=await a.from("user_level_benefits").select("*, level_benefit:level_benefit_id(*)").eq("user_id",e).eq("level_benefit_id",t).eq("status","unlocked").single();if(o)throw new Error("Benefit not found or not unlocked");const{data:s,error:n}=await a.from("user_level_benefits").update({status:"used",used_at:new Date().toISOString()}).eq("id",i.id).select().single();if(n)throw n;return(l=(u=i.level_benefit)==null?void 0:u.benefit_data)!=null&&l.points_cost&&await this.createPointsTransaction(e,-i.level_benefit.benefit_data.points_cost,"spend",`Used level benefit: ${i.level_benefit.name}`,i.id,"level_benefit",r),s},async createPointsTransaction(e,t,r,i,o,s,n){const{data:u,error:l}=await a.rpc("record_points_transaction",{p_user_id:e,p_points:t,p_transaction_type:r,p_reason:i,p_reference_id:o,p_reference_type:s,p_metadata:n});if(l)throw l;const{data:c,error:d}=await a.from("points_transactions").select("*").eq("id",u).single();if(d)throw d;return c},async getPointsTransactions(e,t=20,r=0){const{data:i,error:o}=await a.from("points_transactions").select("*").eq("user_id",e).order("created_at",{ascending:!1}).range(r,r+t-1);if(o)throw o;return i||[]},async awardPoints(e,t,r,i,o,s){if(!e)return{success:!1};try{const n=await this.getUserPoints(e);if(!n)return{success:!1};const u=n.level,{data:l,error:c}=await a.rpc("record_points_transaction",{p_user_id:e,p_points:t,p_transaction_type:t>=0?"earn":"spend",p_reason:r,p_reference_id:i,p_reference_type:o,p_metadata:s});if(c)return console.error("Error recording points transaction:",c),{success:!1};const d=await this.getUserPoints(e);return d?{success:!0,newLevel:d.level,levelUp:d.level>u}:{success:!0}}catch(n){return console.error("Error adding points:",n),{success:!1}}},async getPointsHistory(e){if(!e)return[];const{data:t,error:r}=await a.from("points_transactions").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(50);return r?(console.error("Error fetching points history:",r),[]):t||[]},async getNutritionStreaks(e){const{data:t,error:r}=await a.from("nutrition_streaks").select("*").eq("user_id",e);if(r)throw r;return t||[]},async createNutritionGoal(e,t,r,i){const{data:o,error:s}=await a.from("nutrition_goals").insert({user_id:e,goal_type:t,target_value:r,end_date:i}).select().single();if(s)throw s;return o},async getNutritionGoals(e){const{data:t,error:r}=await a.from("nutrition_goals").select("*").eq("user_id",e).eq("status","active");if(r)throw r;return t||[]},async updateNutritionGoalProgress(e,t){const{data:r,error:i}=await a.from("nutrition_goals").update({current_value:t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(i)throw i;return r.current_value>=r.target_value&&(await this.completeNutritionGoal(e),await this.awardPoints(r.user_id,50,"goal_completed",e,"nutrition_goal")),r},async completeNutritionGoal(e){const{data:t,error:r}=await a.from("nutrition_goals").update({status:"completed",updated_at:new Date().toISOString()}).eq("id",e).select().single();if(r)throw r;return t},async logDailyNutrition(e,t){const r=new Date().toISOString().split("T")[0],{data:i}=await a.from("daily_nutrition_logs").select("*").eq("user_id",e).eq("log_date",r).maybeSingle();if(i){const{data:o,error:s}=await a.from("daily_nutrition_logs").update({...t,updated_at:new Date().toISOString()}).eq("id",i.id).select().single();if(s)throw s;return o}else{const{data:o,error:s}=await a.from("daily_nutrition_logs").insert({user_id:e,log_date:r,...t}).select().single();if(s)throw s;return await this.awardPoints(e,10,"daily_log"),o}},async getDailyNutritionLogs(e,t=7){const r=new Date().toISOString().split("T")[0],i=new Date;i.setDate(i.getDate()-t);const o=i.toISOString().split("T")[0],{data:s,error:n}=await a.from("daily_nutrition_logs").select("*").eq("user_id",e).gte("log_date",o).lte("log_date",r).order("log_date",{ascending:!1});if(n)throw n;return s||[]},async getLeaderboards(){const{data:e,error:t}=await a.from("leaderboards").select("*");if(t)throw t;return e||[]},async getLeaderboardEntries(e){const{data:t,error:r}=await a.from("leaderboard_entries").select("*").eq("leaderboard_id",e).order("rank",{ascending:!0});if(r)throw r;return t||[]},async getNutritionTips(e,t){let r=a.from("nutrition_tips").select("*").eq("active",!0);e&&(r=r.eq("category",e)),t&&(r=r.eq("difficulty_level",t));const{data:i,error:o}=await r;if(o)throw o;return i||[]},async markTipAsSeen(e,t,r=!1){const{error:i}=await a.from("user_tips").upsert({user_id:e,tip_id:t,seen_at:new Date().toISOString(),saved:r});if(i)throw i},async getSavedTips(e){const{data:t,error:r}=await a.from("user_tips").select("tip:tip_id(*)").eq("user_id",e).eq("saved",!0);if(r)throw r;return(t==null?void 0:t.map(i=>i.tip))||[]},async checkAndUpdateAchievements(e){try{const t=await this.getAchievements(),[r,i,o,s]=await Promise.all([this.getUserPoints(e),this.getUserChallenges(e),this.getDailyNutritionLogs(e,30),this.getNutritionStreaks(e)]);for(const n of t){const{data:u}=await a.from("user_achievements").select("id").eq("user_id",e).eq("achievement_id",n.id).maybeSingle();if(u)continue;let l=!1;if(n.requirements.level&&r.level>=n.requirements.level&&(l=!0),n.requirements.meals_logged&&o.length>=n.requirements.meals_logged&&(l=!0),n.requirements.challenges_completed&&i.filter(d=>d.status==="completed").length>=n.requirements.challenges_completed&&(l=!0),n.requirements.daily_logs){const c=s.find(d=>d.streak_type==="daily_log");(c&&n.requirements.consecutive&&c.current_streak>=n.requirements.daily_logs||!n.requirements.consecutive&&c.longest_streak>=n.requirements.daily_logs)&&(l=!0)}n.requirements.water_goal_met&&o.filter(d=>d.water_cups>=8).length>=n.requirements.water_goal_met&&(l=!0),l&&await this.awardAchievement(e,n.id)}}catch(t){console.error("Error checking achievements:",t)}},async checkAndAwardBadges(e){try{const t=await this.getUserAchievements(e),r=await this.getBadges(),i=t.filter(s=>{var n;return((n=s.achievement)==null?void 0:n.category)==="nutrition"}).length,o=t.filter(s=>{var n;return((n=s.achievement)==null?void 0:n.category)==="consistency"}).length;for(const s of r)s.category==="meta"&&s.name==="Nutrition Guru"&&i>=10&&await this.awardBadge(e,s.id),s.category==="consistency"&&s.name==="Streak Master"&&(await this.getNutritionStreaks(e)).reduce((l,c)=>c.longest_streak>l?c.longest_streak:l,0)>=30&&await this.awardBadge(e,s.id)}catch(t){console.error("Error awarding badges:",t)}},async getUserStreak(e){if(!e)return 0;const{data:t,error:r}=await a.rpc("get_user_streak",{p_user_id:e});return r?(console.error("Error fetching user streak:",r),0):t||0},async updateUserStreak(e){if(!e)return!1;const{data:t,error:r}=await a.rpc("update_user_streak",{p_user_id:e});return r?(console.error("Error updating user streak:",r),!1):!0},async getUserLevels(){const{data:e,error:t}=await a.from("user_levels").select("*").order("level",{ascending:!0});return t?(console.error("Error fetching user levels:",t),_):e.map(r=>({level:r.level,min_points:r.min_points,max_points:r.max_points,title:r.title}))||_}};export{f as g};
